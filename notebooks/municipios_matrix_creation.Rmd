---
title: "municipios_matrix_creation"
output: html_document
---

```{r message=FALSE, warning=FALSE, results='hide'}
options(scipen=10000)
source("../utils.R")
```

###########################################################################
AMENAZAS
###########################################################################
## TODO
* Checar ingesta de cngmd_participacion_ciudadana. Según Luigi todo está pero no.
* Delitos la hizo Moni
* Hacer tidy la de cngmd_transparencia.

```{r, results = "hide"}
# Cenapred 
cenapred <- large_table(con,clean,cenapred_app_municipios) %>%
  select(cve_muni,gp_inundac,gp_sequia2,gp_bajaste,gp_ciclnes,g_suscelad,gp_sismico,gp_tsunami) %>%  
  mutate(cve_muni = as.integer(cve_muni)) %>% retrieve_result()

# Intercensal 2015
intercensal <- large_table(con,raw, intercensal_persona_2015) %>%
  select(ent,mun, numper) %>% group_by(ent, mun) %>%
  dplyr::summarise(numper = sum(numper)) %>%
  mutate(cve_muni= as.integer(paste0(ent,mun))) %>% retrieve_result()

# Migración interna y externa
# Poblaciones flotantes

# Delitos


# Join
amenazas <- cenapred
#amenazas <- left_join(intercensal,cenapred,delitos, by="cve_muni")

# Generación de Reporte
create_reports(amenazas, 
               task_name = "amenazas", 
               output_dir = "../eda/reportes/amenazas")
```



###########################################################################
CAPACIDADES
###########################################################################

```{r,, results = "hide"}

# Selección y Construcción de Variables

# CFE 
cfe <- dbGetQuery(con,'
  SELECT  LPAD(cveedo::text, 2, \'0\') || LPAD(cvemun::text, 3, \'0\') as cve_muni, sum(num) as n_usuarios
  FROM raw.cfe
  WHERE tipo LIKE \'Usuarios\'
  GROUP BY cve_muni')

# Internet
internet <- large_table(con,raw,internet_municipios) %>% 
  select(cve_muni,pct_viv_con_internet)  
 

#Complejidad Economica, Diversificación Económica, Productividad de la tierra
complejidad <- large_table(con,raw,complejidad_municipios) %>% select(cve_muni, complejidad_2014)

# Flexibilidad financiera, Capacidad de Inversión
indicadores_finanzas <- large_table(con,raw,indicadores_financieros_municipios) %>%
  filter(anio == 2014) %>%
  select(cve_muni,flexibilidad_financiera,capacidad_inversion) 

# Índice de Reglamentación
indice_reglamentacion <- large_table(con,raw,indice_reglamentacion_municipios) %>% 
  filter(anio == 2014) %>%
  select(cve_muni,indice)

# Densidad de Medicos, Densidad de camas, Densidad de Hospitales
hospitales <- dbGetQuery(con,'
  SELECT LPAD(claveentidad::text, 2, \'0\') || LPAD(clavemunicipio::text, 3, \'0\') as cve_muni, 
  avg(CAST(e1819+e20 as float)/1000) as densidad_medicos, 
  avg(CAST(unidades+e13 as float)/1000) as densidad_hospitales, 
  avg(CAST(e14+e15 as float)/1000) as densidad_camas
  FROM raw.recursos_hospitales
  GROUP BY cve_muni')

# Defunciones
defunciones_grales <- dbGetQuery(con,'
  SELECT LPAD(ent_ocurr::text, 2, \'0\') || LPAD(mun_ocurr::text, 3, \'0\') as cve_muni, 
  sum(CASE 
      WHEN CAST(edad as integer) < 4000
          THEN 1 
          ELSE 0 
      END) as infant, 
  sum(CASE 
      WHEN causa_def LIKE \'O%\'
          THEN 1 
          ELSE 0 
      END) as materna
  FROM raw.defunciones_generales
  GROUP BY cve_muni')

#Censo Nacional de Gobiernos Municipales y Delegacionales
cngmd_proteccion_civil <- large_table(con,raw,cngmd_proteccion_civil) %>%
  mutate(cve_muni = as.character(ubic_geo)) %>%
  select(cve_muni, nd_spnn1,nd_nsnn4) 

cngmd_drenaje <- large_table(con,raw,cngmd_drenaje) %>%
  mutate(cve_muni = as.character(aps_folio),cobertura_dren=(sd_dren_cab+sd_dren_resto)/2)  %>%
  select(cve_muni,cobertura_dren)

cngmd_predial <- large_table(con,raw,cngmd_predial) %>%
  mutate(cve_muni = as.character(ubic_geo)) %>%
  select(cve_muni,aut_cobr,totalpo1)

cngmd_recoleccion_basura <- large_table(con,raw,cngmd_recoleccion_basura) %>%
  mutate(cve_muni = as.character(rsu_folio)) %>% select(cve_muni,basura_porcent_cab)

cngmd_transparencia1 <- large_table(con,raw,cngmd_transparencia) %>%
  mutate(cve_muni = as.character(ubic_geo)) %>%
  select(cve_muni,inf_publ) %>% retrieve_result() %>% distinct() %>% group_by_at(vars(inf_publ))%>% mutate(i = row_number()) %>% spread(cve_muni,inf_publ)

cngmd_transparencia2 <- large_table(con,raw,cngmd_transparencia) %>%
  mutate(cve_muni = as.character(ubic_geo)) %>%
  select(cve_muni,mec_tran) %>% retrieve_result() %>% distinct() %>% group_by_at(vars(mec_tran))%>% mutate(i = row_number()) %>% spread(mec_tran,cve_muni)

cngmd_transparencia <- left_join(cngmd_transparencia1,cngmd_transparencia2,by = 'cve_uni')

cngmd_participacion_ciudadana <- large_table(con,raw,cngmd_participacion_ciudadana)

# Join
capacidades <- left_join(complejidad,internet, by="cve_muni") %>%
  left_join(cngmd_proteccion_civil, by="cve_muni")%>%
  left_join(cngmd_drenaje, by="cve_muni") %>% 
  left_join(cngmd_predial, by="cve_muni") %>% 
  left_join(cngmd_recoleccion_basura, by="cve_muni") %>% retrieve_result()
aux <- left_join(indice_reglamentacion,indicadores_finanzas,by= "cve_muni") %>% retrieve_result()
capacidades <- capacidades %>%
  left_join(defunciones_grales, by="cve_muni") %>%
  left_join(cfe, by="cve_muni") %>%
  left_join(aux, by="cve_muni") %>%
  left_join(hospitales, by="cve_muni") 

capacidades_numericas <- na.omit(scale(select.i(capacidades, is.numeric)))

# Generación de Reporte
create_reports(capacidades_numericas %>% data.table(),  
               task_name = "capacidades", 
               output_dir = "../eda/reportes/capacidades")
```

###########################################################################
VULNERABILIDADES
###########################################################################

```{r}
#CONEVAL
#dbrsocial::clear_results(connection = con)
coneval <- large_table(con,clean,coneval_municipios) %>%   
filter(data_date == "2015-a") %>% 
select(cve_muni, ic_rezedu_porcentaje, ic_asalud_porcentaje, ic_segsoc_porcentaje, ic_cv_porcentaje, vul_ing_porcentaje, ic_sbv_porcentaje, pobreza_porcentaje) %>% 
mutate(cve_muni = as.integer(cve_muni)) %>% retrieve_result()
```

```{r}
#GRUPOS ETARIOS
#MAYORES DE 65

intercensal <- dbGetQuery(con,'
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni, 
  sum (factor) as poblacion_mun,
  sum(CASE 
        WHEN CAST(edad as integer) > 64
            THEN factor 
            ELSE 0 
        END) as mayores65
  FROM raw.intercensal_personas_2015
  GROUP BY cve_muni')

intercensal_poblacion_mayor <- intercensal %>% 
  mutate(poblacion_mayor = as.double(mayores65)/poblacion_mun) %>% 
  mutate(porcentaje_poblacion_mayor = poblacion_mayor*100) 

#MENORES DE 5 AÑOS
intercensal <- dbGetQuery(con,'
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni, 
  sum (factor) as poblacion_mun,
  sum(CASE 
        WHEN CAST(edad as integer) < 6
            THEN factor 
            ELSE 0 
        END) as menores5
  FROM raw.intercensal_personas_2015
  GROUP BY cve_muni')

intercensal_poblacion_infantil <- intercensal %>% 
  mutate(poblacion_infantil = as.double(menores5)/poblacion_mun) %>% 
  mutate(porcentaje_poblacion_infantil = poblacion_infantil*100) 

#ADULTOS 19-29
intercensal <- dbGetQuery(con,'
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni, 
  sum (factor) as poblacion_mun,
  sum(CASE 
        WHEN CAST(edad as integer) < 30 AND edad >18
            THEN factor 
            ELSE 0 
        END) as adultos
  FROM raw.intercensal_personas_2015
  GROUP BY cve_muni')

intercensal_poblacion_adulta <- intercensal %>% 
  mutate(poblacion_adulta = as.double(adultos)/poblacion_mun) %>% 
  mutate(porcentaje_poblacion_adulta = poblacion_adulta*100)

#RELACION DE DEPENDENCIA
intercensal <- dbGetQuery(con,'
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni, 
  sum (factor) as poblacion_mun,
  sum(CASE 
        WHEN CAST(edad as integer) < 15
            THEN factor 
            ELSE 0 
        END) as menores,
  sum(CASE 
        WHEN CAST(edad as integer) > 64
            THEN factor 
            ELSE 0 
        END) as mayores
  FROM raw.intercensal_personas_2015
  GROUP BY cve_muni')

intercensal_poblacion_dependiente <- intercensal %>% 
  mutate(poblacion_dependiente = menores+mayores) %>%
  mutate(proporcion_dependiente = as.double(poblacion_dependiente)/poblacion_mun) %>% 
  mutate(porcentaje_poblacion_dependiente = proporcion_dependiente*100)


#AUTOADSCRIPCIÓN
intercensal <- dbGetQuery(con,'
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni, 
  sum (factor) as poblacion_mun,
  sum(CASE 
        WHEN CAST(perte_indigena as integer) = 1 OR CAST(perte_indigena as integer) = 2
            THEN factor 
            ELSE 0 
        END) as indigenas
  FROM raw.intercensal_personas_2015
  GROUP BY cve_muni')

intercensal_poblacion_indigena <- intercensal %>% 
  mutate(proporcion_indigena = as.double(indigenas)/poblacion_mun) %>% 
  mutate(porcentaje_poblacion_indigena = proporcion_indigena*100)

#LENGUA INDÍGENA
intercensal <- dbGetQuery(con,'  
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni, 
  sum (factor) as poblacion_mun,
  sum(CASE 
        WHEN CAST(hlengua as integer) = 1 
            THEN factor 
            ELSE 0 
        END) as lengua_indigena
  FROM raw.intercensal_personas_2015
  GROUP BY cve_muni')

intercensal_poblacion_lengua_indigena <- intercensal %>% 
  mutate(proporcion_lengua_indigena = as.double(lengua_indigena)/poblacion_mun) %>% 
  mutate(porcentaje_poblacion_lengua_indigena = proporcion_lengua_indigena*100)

#AFRODESCENDIENTE
intercensal <- dbGetQuery(con,'  
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni, 
  sum (factor) as poblacion_mun,
  sum(CASE 
        WHEN CAST(afrodes as integer) = 1 OR CAST(afrodes as integer) = 2 
            THEN factor 
            ELSE 0 
        END) as afrodescendientes
  FROM raw.intercensal_personas_2015
  GROUP BY cve_muni')

intercensal_poblacion_afrodescendiente <- intercensal %>% 
  mutate(proporcion_afrodescendientes = as.double(afrodescendientes)/poblacion_mun) %>% 
  mutate(porcentaje_poblacion_afrodescendiente = proporcion_afrodescendientes*100)

#HOGARES UNIPERSONALES
intercensal_viviendas <- dbGetQuery(con,'  
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni,
  sum (factor) as viviendas_mun,
  sum(CASE 
        WHEN CAST(tipohog as integer) = 5
            THEN factor 
            ELSE 0 
        END) as unipersonales
  FROM raw.intercensal_viviendas_2015
  GROUP BY cve_muni')

intercensal_unipersonales <- intercensal_viviendas %>% 
  mutate(proporcion_unipersonales = as.double(unipersonales)/viviendas_mun) %>% 
  mutate(porcentaje_hogares_unipersonales = proporcion_unipersonales*100)

#JEFATURA FEMENINA
intercensal_viviendas <- dbGetQuery(con,'  
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni,
  sum (factor) as viviendas_mun,
  sum(CASE 
        WHEN CAST(jefe_sexo as integer) = 3
            THEN factor 
            ELSE 0 
        END) as jefatura_fem
  FROM raw.intercensal_viviendas_2015
  GROUP BY cve_muni')

intercensal_jefatura_femenina <- intercensal_viviendas %>% 
  mutate(proporcion_jefatura = as.double(jefatura_fem)/viviendas_mun) %>% 
  mutate(porcentaje_hogares_jefafem = proporcion_jefatura*100)

#MUJERES
intercensal <- dbGetQuery(con,'  
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni, 
  sum (factor) as poblacion_mun,
  sum(CASE 
        WHEN CAST(sexo as integer) = 3 
            THEN factor 
            ELSE 0 
        END) as mujeres
  FROM raw.intercensal_personas_2015
  GROUP BY cve_muni')

intercensal_poblacion_femenina <- intercensal %>% 
  mutate(proporcion_mujeres = as.double(mujeres)/poblacion_mun) %>% 
  mutate(porcentaje_poblacion_femenina = proporcion_mujeres*100)

#HOMBRES
intercensal <- dbGetQuery(con,'  
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni, 
  sum (factor) as poblacion_mun,
  sum(CASE 
        WHEN CAST(sexo as integer) = 1 
            THEN factor 
            ELSE 0 
        END) as hombres
  FROM raw.intercensal_personas_2015
  GROUP BY cve_muni')

intercensal_poblacion_masculina <- intercensal %>% 
  mutate(proporcion_hombres = as.double(hombres)/poblacion_mun) %>% 
  mutate(porcentaje_poblacion_masculina = proporcion_hombres*100)

#MUJERES EN EL MERCADO LABORAL
intercensal <- dbGetQuery(con,'
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni,
  sexo,
  edad,
  conact, 
  factor
  FROM raw.intercensal_personas_2015
 ')

intercensal_ocupadas <- intercensal %>% 
  filter(sexo == 3) %>% 
  mutate(mujeres = ifelse(sexo == 3, 1, 0),
         edad_trabajar = ifelse(edad > 14, 1, 0),
         ocupadas = ifelse(conact == 10 & 11 & 12 & 13 & 14 & 15 & 16, 1, 0)) %>% 
  mutate(mujeres_f = mujeres*factor,
         edad_trabajar_f = edad_trabajar*factor,
         ocupadas_f = ocupadas*factor) 
  
intercensal_ocupadas[is.na(intercensal_ocupadas)] <- 0

intercensal_ocupadas <- intercensal_ocupadas %>% 
  group_by(cve_muni)  %>% 
  summarise_all(sum)

intercensal_ocupadas <- mutate(intercensal_ocupadas, 
                               proporcion_mujeres_ocupadas = ocupadas_f/edad_trabajar_f,
                               porcentaje_mujeres_ocupadas = proporcion_mujeres_ocupadas*100)

intercensal_ocupadas <- subset(intercensal_ocupadas, 
                                      select = c(cve_muni, mujeres_f, edad_trabajar_f, ocupadas_f, porcentaje_mujeres_ocupadas))

#HOMBRES EN EL MERCADO LABORAL
intercensal <- dbGetQuery(con,'
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni,
  sexo,
  edad,
  conact, 
  factor
  FROM raw.intercensal_personas_2015
 ')

intercensal_ocupados <- intercensal %>% 
  filter(sexo == 1) %>% 
  mutate(hombres = ifelse(sexo == 1, 1, 0),
         edad_trabajar = ifelse(edad > 14, 1, 0),
         ocupados = ifelse(conact == 10 & 11 & 12 & 13 & 14 & 15 & 16, 1, 0)) %>% 
  mutate(hombres_f = hombres*factor,
         edad_trabajar_f = edad_trabajar*factor,
         ocupados_f = ocupados*factor) 
  
intercensal_ocupados[is.na(intercensal_ocupados)] <- 0

intercensal_ocupados <- intercensal_ocupados %>% 
  group_by(cve_muni)  %>% 
  summarise_all(sum)

intercensal_ocupados <- mutate(intercensal_ocupados, 
                               proporcion_hombres_ocupados = ocupados_f/edad_trabajar_f,
                               porcentaje_hombres_ocupados = proporcion_hombres_ocupados*100)

intercensal_ocupados <- subset(intercensal_ocupados, 
                                      select = c(cve_muni, hombres_f, edad_trabajar_f, ocupados_f, porcentaje_hombres_ocupados))


#MIGRACION INTERNA RECIENTE
intercensal <- dbGetQuery(con,'  
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni, 
  sum (factor) as poblacion_mun,
  sum(CASE 
        WHEN nom_mun != nom_mun_res10 
            THEN factor 
            ELSE 0 
        END) as migrantes_internos_recientes
  FROM raw.intercensal_personas_2015
  GROUP BY cve_muni')

intercensal_migracion_interna_reciente <- intercensal %>% 
  mutate(proporcion_migracion_interna_reciente = as.double(migrantes_internos_recientes)/poblacion_mun) %>% 
  mutate(porcentaje_migrantes_internos_recientes = proporcion_migracion_interna_reciente*100)

#MIGRACION EXTERNA RECIENTE
intercensal <- dbGetQuery(con,'
  SELECT LPAD(ent::text, 2, \'0\') || LPAD(mun::text, 3, \'0\') as cve_muni, 
  sum (factor) as poblacion_mun,
  sum(CASE 
        WHEN CAST(ent_pais_res10 as integer) > 33
            THEN factor 
            ELSE 0 
        END) as migrantes
  FROM raw.intercensal_personas_2015
  GROUP BY cve_muni')

intercensal_migracion_externa_reciente <- intercensal %>% 
  mutate(proporcion_externa = as.double(migrantes)/poblacion_mun) %>% 
  mutate(porcentaje_migrantes_externos_recientes = proporcion_externa*100)

 ```

```{r}
#Tiempo destinado a trabajo no remunerado, Brecha promedio de horas de trabajo de cuidados
cuidados <-large_table(con, raw,enut_cuidados) %>% retrieve_result()
```
* Volver a hacer la ingesta con la cve_muni

```{r}
concentrados <-large_table(con, clean, enigh_concentrados) %>% retrieve_result()
hogares <-large_table(con,clean, enigh_hogares) %>% retrieve_result()
ingresos <-large_table(con, clean, enigh_ingresos) %>% retrieve_result()
ingreso <-large_table(con, features, enigh_ingreso) %>% retrieve_result()
poblacion <-large_table(con, clean, enigh_poblacion) %>% retrieve_result()
trabajos <-large_table(con, clean, enigh_trabajos) %>% retrieve_result()
viviendas <-large_table(con, clean, enigh_viviendas) %>% retrieve_result()
carencias <-large_table(con, features, enigh_carencias) %>% retrieve_result()
gasto_hogar <-large_table(con, raw, enigh_gastohogar) %>% retrieve_result()
gasto_personas <-large_table(con, raw, enigh_gastopersonas) %>% retrieve_result()

concentrados$factor_hog <- as.integer(concentrados$factor_hog)
gasto_hogar$costo <- as.numeric(gasto_hogar$costo)
gasto_hogar$gasto_nm <- as.numeric(gasto_hogar$gasto_nm)
gasto_personas$gasto <- as.integer(gasto_personas$gasto)
gasto_personas$gasto_tri <- as.numeric(gasto_personas$gasto_tri)

enigh1 <- left_join(concentrados,hogares) 
enigh2 <- left_join(ingreso,ingresos) 
enigh3 <- left_join(poblacion,trabajos) 
enigh4 <- left_join(carencias,viviendas) 
enigh5 <- left_join(gasto_personas,gasto_hogar) 

enigh6 <- left_join(enigh1,enigh2)
enigh7 <- left_join(enigh3,enigh4)

enigh5$material <- as.numeric(enigh5$material)
enigh8 <- left_join(enigh5,enigh6)

enigh7$ubica_geo <- as.integer(enigh7$ubica_geo)
enigh <- left_join(enigh7,enigh8)

rm(concentrados,hogares,ingreso,ingresos,gasto_hogar,gasto_personas,carencias,viviendas,trabajos,poblacion,enigh1,enigh2,enigh3,enigh4,enigh5,enigh6,enigh7,enigh8)
```
* a nivel hogares

```{r}
v_uno <- left_join(intercensal,coneval)
```