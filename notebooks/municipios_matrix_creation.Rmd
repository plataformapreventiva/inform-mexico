---
title: "municipios_matrix_creation"
output: html_document
---

```{r}
options(scipen=10000)
source("../utils.R")
```
###########################################################################
AMENAZAS
###########################################################################

```{r, results = "hide"}
# Cenapred 
cenapred <- large_table(con,clean,cenapred_app_municipios) %>%
  select(cve_muni,gp_inundac,gp_sequia2,gp_bajaste,gp_ciclnes,g_suscelad,gp_sismico,gp_tsunami) 

# Intercensal 2015
intercensal <- large_table(con,raw, intercensal_persona_2015) %>%
  select(ent,mun, numper) %>% group_by(ent, mun) %>%
  dplyr::summarise(numper = sum(numper)) %>%
  mutate(cve_muni= as.integer(paste0(ent,mun))) %>% retrieve_result()

# Migración interna y externa
# Poblaciones flotantes

# Delitos
delitos <- large_table(con,features, crimenes_tasas) %>%
  select(cve_muni,homicidio_culposo,homicidio_doloso,feminicidio,secuestro,robo_vehiculos,violencia_familiar,incidencia_total) %>%
  group_by(cve_muni) %>%
    summarise(homicidio_culposo=avg(homicidio_culposo),homicidio_doloso=avg(homicidio_doloso),feminicidio=avg(feminicidio),secuestro=avg(secuestro),robo_vehiculos=avg(robo_vehiculos),violencia_familiar=avg(violencia_familiar),incidencia_total = avg(incidencia_total))

#Join
amenazas <- left_join(cenapred,delitos, by="cve_muni") %>% retrieve_result()
#amenazas <- left_join(intercensal,cenapred,delitos, by="cve_muni")

# Generación de Reporte
create_reports(amenazas, 
               task_name = "amenazas", 
               output_dir = "../eda/reportes/amenazas")

```



###########################################################################
CAPACIDADES
###########################################################################

```{r,, results = "hide"}

# Selección y Construcción de Variables

# CFE 
cfe <- dbGetQuery(con,'
  SELECT LPAD(cveinegi::text, 2, \'0\') || LPAD(cvemun::text, 3, \'0\') as cve_muni, sum(num) as n_usuarios
  FROM raw.cfe
  WHERE tipo like \'Usuarios\'
  GROUP BY cve_muni')

# Internet
internet <- large_table(con,raw,internet_municipios) %>% 
  select(cve_muni,pct_viv_con_internet)  

#Complejidad Economica, Diversificación Económica, Productividad de la tierra
complejidad <- large_table(con,raw,complejidad_municipios) %>% select(cve_muni, complejidad_2014)

# Flexibilidad financiera, Capacidad de Inversión
indicadores_finanzas <- large_table(con,raw,indicadores_financieros_municipios) %>%
  filter(anio == 2014) %>%
  select(cve_muni,flexibilidad_financiera,capacidad_inversion) 

# Índice de Reglamentación
indice_reglamentacion <- large_table(con,raw,indice_reglamentacion_municipios) %>% 
  filter(anio == 2014) %>%
  select(cve_muni,indice)

# Densidad de Medicos, Densidad de camas, Densidad de Hospitales
hospitales <- dbGetQuery(con,'
  SELECT LPAD(claveentidad::text, 2, \'0\') || LPAD(clavemunicipio::text, 3, \'0\') as cve_muni, 
  avg(CAST(e1819+e20 as float)/1000) as densidad_medicos, 
  avg(CAST(unidades+e13 as float)/1000) as densidad_hospitales, 
  avg(CAST(e14+e15 as float)/1000) as densidad_camas
  FROM raw.recursos_hospitales
  GROUP BY cve_muni')

# Defunciones
defunciones_grales <- dbGetQuery(con,'
  SELECT LPAD(ent_ocurr::text, 2, \'0\') || LPAD(mun_ocurr::text, 3, \'0\') as cve_muni, 
  sum(CASE 
      WHEN CAST(edad as integer) < 4000
          THEN 1 
          ELSE 0 
      END) as infant, 
  sum(CASE 
      WHEN causa_def LIKE \'O%\'
          THEN 1 
          ELSE 0 
      END) as materna
  FROM raw.defunciones_generales
  GROUP BY cve_muni')

#Censo Nacional de Gobiernos Municipales y Delegacionales
cngmd_proteccion_civil <- large_table(con,raw,cngmd_proteccion_civil) %>%
  mutate(cve_muni = as.character(ubic_geo)) %>%
  select(cve_muni, nd_spnn1,nd_nsnn4) 

cngmd_drenaje <- large_table(con,raw,cngmd_drenaje) %>%
  mutate(cve_muni = as.character(aps_folio),cobertura_dren=(sd_dren_cab+sd_dren_resto)/2)  %>%
  select(cve_muni,cobertura_dren)

cngmd_predial <- large_table(con,raw,cngmd_predial) %>%
  mutate(cve_muni = as.character(ubic_geo)) %>%
  select(cve_muni,aut_cobr,totalpo1)

cngmd_recoleccion_basura <- large_table(con,raw,cngmd_recoleccion_basura) %>%
  mutate(cve_muni = as.character(rsu_folio)) %>% select(cve_muni,basura_porcent_cab)

cngmd_participacion_ciudadana <- large_table(con,raw,cngmd_participacion_ciudadana) %>% 
  mutate(cve_muni = as.character(ubic_geo)) %>%
  select(cve_muni,nd_nsnn1,tem_pciu)

cngmd_transparencia_1 <- large_table(con,raw,cngmd_transparencia) %>%
  select(ubic_geo,mec_tran) %>% distinct() %>% 
  mutate(cve_muni = as.character(ubic_geo),
         mec_tran = ifelse(mec_tran==1 & mec_tran==3 & mec_tran==6,1,
                           ifelse((mec_tran==1 & mec_tran==3)||
                                    (mec_tran==1 & mec_tran==6)||
                                    (mec_tran==3 & mec_tran==6),2/3,
                                  ifelse(mec_tran==1 || mec_tran==3||
                                    mec_tran==6,1/3,0)))) %>% 
  select(-ubic_geo) %>% group_by(cve_muni) %>%
  summarise(mec_tran=sum(mec_tran,na.rm = TRUE))

cngmd_transparencia_2 <- large_table(con,raw,cngmd_transparencia) %>%
  select(ubic_geo,inf_publ) %>% distinct() %>% 
  mutate(cve_muni = as.character(ubic_geo),
         inf_publ = ifelse(inf_publ==5 & inf_publ==22 & inf_publ==23 &
                             inf_publ==42 & inf_publ==44,1,
                           ifelse((inf_publ==5 & inf_publ==22 & inf_publ==23 &
                                     inf_publ==42) || 
                                    (inf_publ==5 & inf_publ==22 & inf_publ==23 &
                                       inf_publ==44) ||
                                    (inf_publ==5 & inf_publ==22 & inf_publ==42 &
                                       inf_publ==44) ||
                                    (inf_publ==5 & inf_publ==23 & inf_publ==42 &
                                       inf_publ==44) ||
                                    (inf_publ==22 & inf_publ==23 & inf_publ==42 &
                                       inf_publ==44),4/5,
                                  ifelse((inf_publ==5 & inf_publ==22 &
                                            inf_publ==23) ||
                                           (inf_publ==5 & inf_publ==22 &
                                              inf_publ==42) ||
                                           (inf_publ==5 & inf_publ==22 &
                                              inf_publ==44) ||
                                           (inf_publ==5 & inf_publ==23 &
                                            inf_publ==42) ||
                                           (inf_publ==5 & inf_publ==23 &
                                            inf_publ==44) ||
                                           (inf_publ==5 & inf_publ==42 &
                                            inf_publ==44) ||
                                           (inf_publ==22 & inf_publ==23 &
                                            inf_publ==42) ||
                                           (inf_publ==22 & inf_publ==23 &
                                            inf_publ==44)||
                                           (inf_publ==22 & inf_publ==42 &
                                            inf_publ==44) ||
                                           (inf_publ==23 & inf_publ==42 &
                                            inf_publ==44),3/5,
                                         ifelse((inf_publ==5 & inf_publ==22)||
                                                  (inf_publ==5 & inf_publ==23)||
                                                  (inf_publ==5 & inf_publ==42)||
                                                  (inf_publ==5 & inf_publ==44)||
                                                  (inf_publ==22 & inf_publ==23)||
                                                  (inf_publ==22 & inf_publ==42)||
                                                  (inf_publ==22 & inf_publ==44)||
                                                  (inf_publ==23 & inf_publ==42)||
                                                  (inf_publ==23 & inf_publ==44)||
                                                  (inf_publ==42 & inf_publ==44),
                                                2/5,
                                                ifelse(inf_publ==5 || 
                                                         inf_publ==22 ||
                                                         inf_publ==23 ||
                                                         inf_publ==42 ||
                                                         inf_publ==44,
                                                       1/5,0)))))) %>% 
  select(-ubic_geo) %>% group_by(cve_muni) %>%
  summarise(inf_publ=sum(inf_publ,na.rm = TRUE))

cngmd_transparencia <- left_join(cngmd_transparencia_1,
                                 cngmd_transparencia_2,
                                 by="cve_muni")
# Join
capacidades <- left_join(complejidad,internet, by="cve_muni") %>%
  left_join(cngmd_proteccion_civil, by="cve_muni") %>%
  left_join(cngmd_drenaje, by="cve_muni") %>% 
  left_join(cngmd_predial, by="cve_muni") %>% 
  left_join(cngmd_recoleccion_basura, by="cve_muni") %>%
  left_join(cngmd_participacion_ciudadana, by="cve_muni") %>%
  left_join(cngmd_transparencia, by="cve_muni") %>%
  retrieve_result()
aux <- left_join(indice_reglamentacion,indicadores_finanzas,by= "cve_muni") %>% retrieve_result()
capacidades <- capacidades %>%
  left_join(defunciones_grales, by="cve_muni") %>%
  left_join(cfe, by="cve_muni") %>%
  left_join(aux, by="cve_muni") %>%
  left_join(hospitales, by="cve_muni") 

capacidades_numericas <- na.omit(scale(select_if(capacidades, is.numeric)))

# Generación de Reporte
create_reports(capacidades_numericas %>% data.table(), 
               task_name = "capacidades", 
               output_dir = "../eda/reportes/capacidades")

create_reports_2(capacidades %>% data.table(), 
               task_name = "capacidades", 
               output_dir = "../eda/reportes/capacidades")
```

###########################################################################
VULNERABILIDADES
###########################################################################

```{r}
#dbrsocial::clear_results(connection = con)
coneval <- large_table(con,clean,coneval_municipios) %>% retrieve_result() %>%
  filter(data_date == "2015-a")
coneval$cve_muni <- as.integer(coneval$cve_muni)
```

```{r}
intercensal <- large_table(con,public,intercensal_mun_2015) %>% mutate(cve_muni= as.integer(paste0(ent,mun))) %>% retrieve_result()
```

```{r}
#Tiempo destinado a trabajo no remunerado, Brecha promedio de horas de trabajo de cuidados
cuidados <-large_table(con, raw,enut_cuidados) %>% retrieve_result()
```
* Volver a hacer la ingesta con la cve_muni

```{r}
concentrados <-large_table(con, clean, enigh_concentrados) %>% retrieve_result()
hogares <-large_table(con,clean, enigh_hogares) %>% retrieve_result()
ingresos <-large_table(con, clean, enigh_ingresos) %>% retrieve_result()
ingreso <-large_table(con, features, enigh_ingreso) %>% retrieve_result()
poblacion <-large_table(con, clean, enigh_poblacion) %>% retrieve_result()
trabajos <-large_table(con, clean, enigh_trabajos) %>% retrieve_result()
viviendas <-large_table(con, clean, enigh_viviendas) %>% retrieve_result()
carencias <-large_table(con, features, enigh_carencias) %>% retrieve_result()
gasto_hogar <-large_table(con, raw, enigh_gastohogar) %>% retrieve_result()
gasto_personas <-large_table(con, raw, enigh_gastopersonas) %>% retrieve_result()

concentrados$factor_hog <- as.integer(concentrados$factor_hog)
gasto_hogar$costo <- as.numeric(gasto_hogar$costo)
gasto_hogar$gasto_nm <- as.numeric(gasto_hogar$gasto_nm)
gasto_personas$gasto <- as.integer(gasto_personas$gasto)
gasto_personas$gasto_tri <- as.numeric(gasto_personas$gasto_tri)

enigh1 <- left_join(concentrados,hogares) 
enigh2 <- left_join(ingreso,ingresos) 
enigh3 <- left_join(poblacion,trabajos) 
enigh4 <- left_join(carencias,viviendas) 
enigh5 <- left_join(gasto_personas,gasto_hogar) 

enigh6 <- left_join(enigh1,enigh2)
enigh7 <- left_join(enigh3,enigh4)

enigh5$material <- as.numeric(enigh5$material)
enigh8 <- left_join(enigh5,enigh6)

enigh7$ubica_geo <- as.integer(enigh7$ubica_geo)
enigh <- left_join(enigh7,enigh8)

rm(concentrados,hogares,ingreso,ingresos,gasto_hogar,gasto_personas,carencias,viviendas,trabajos,poblacion,enigh1,enigh2,enigh3,enigh4,enigh5,enigh6,enigh7,enigh8)
```
* a nivel hogares

```{r}
v_uno <- left_join(intercensal,coneval)
```