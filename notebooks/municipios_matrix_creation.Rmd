---
title: "municipios_matrix_creation"
output: html_document
---

```{r}
options(scipen=10000)
source("../utils.R")
```

###########################################################################
AMENAZAS
###########################################################################
## TODO
* No existe la base (Moni)
* En estados está la de inpc (mal)



```{r, results = "hide"}
# Cenapred 
cenapred <- large_table(con,clean,cenapred_app_municipios) %>%
  select(cve_muni,gp_inundac,gp_sequia2,gp_bajaste,gp_ciclnes,g_suscelad,gp_sismico,gp_tsunami) %>%  
  mutate(cve_muni = as.integer(cve_muni))

# Intercensal 2015
intercensal <- large_table(con,raw, intercensal_persona_2015) %>%
  select(ent,mun, numper) %>% group_by(ent, mun) %>%
  dplyr::summarise(numper = sum(numper)) %>%
  mutate(cve_muni= as.integer(paste0(ent,mun)))

#delitos <-large_table(con, clean, municipal_delitos) 

# Join
amenazas <- left_join(intercensal,cenapred, by="cve_muni")  %>%
  left_join(delitos, by="cve_muni")

# Construcción de Variables
amenazas %>% 
  mutate(tasa_hom_hab = delitos/poblacion)

# Subset a los índices
amenazas %>% select(tasa_hom_hab) %>% 
  retrieve_result()

# Generación de Reporte
create_reports(amenazas, 
               task_name = "amenazas", 
               output_dir = "../eda/reportes/amenazas")
```



###########################################################################
CAPACIDADES
###########################################################################

```{r}
cfe <- large_table(con,raw,cfe) %>% 
  select(cveedo,cvemun,num) %>% 
  mutate(cvemun = as.integer(cvemun))
```

```{r}
internet <- large_table(con,raw,internet_municipios) %>% 
  select(cve_muni,pct_viv_con_internet) %>% 
  mutate(cve_muni = as.integer(cve_muni))
```

```{r}
#Complejidad Economica, Diversificación Económica, Productividad de la tierra
complejidad <- large_table(con,raw,complejidad_municipios) %>% 
  mutate(cve_muni = as.integer(cve_muni))
```

```{r}
# Flexibilidad financiera, Capacidad de Inversión
indicadores <- large_table(con,raw,indicadores_financieros_municipios) %>%
  %>% select(cve_muni,flexibilidad_financiera,capacidad_inversion) %>%
ind_fin$cve_muni<- as.integer(ind_fin$cve_muni)
```

```{r}
indice_reglamentacion_c <- large_table(con,raw,indice_reglamentacion_municipios) %>% retrieve_result()
indice <- indice_reglamentacion_c %>% select(cve_muni,grado,indice)
rm(indice_reglamentacion_c)
indice$cve_muni<- as.integer(indice$cve_muni)
```

```{r}
#Censo Nacional de Gobiernos Municipales y Delegacionales
cngmd_proteccion_civil <- large_table(con,raw,cngmd_proteccion_civil) %>% retrieve_result()
cngmd_proteccion_civil <- cngmd_proteccion_civil[,-c(17,18)]

cngmd_drenaje <- large_table(con,raw,cngmd_drenaje) %>% retrieve_result()
cngmd_drenaje <- cngmd_drenaje[,-c(15,16)]

cngmd_agua_potable <- large_table(con,raw,cngmd_agua_potable) %>% retrieve_result()
cngmd_agua_potable <- cngmd_agua_potable[,-c(4,5)]

cngmd_predial <- large_table(con,raw,cngmd_predial) %>% retrieve_result()
cngmd_predial <- cngmd_predial[-c(6,7)]

cngmd_recoleccion_basura <- large_table(con,raw,cngmd_recoleccion_basura) %>% retrieve_result() 
cngmd_recoleccion_basura <- cngmd_recoleccion_basura[,-c(85,86)]

#cngmd_transparencia <- large_table(con,raw,cngmd_transparencia) %>% retrieve_result()
#cngmd_transparencia <- cngmd_transparencia[,-c()]

#cngmd_participacion_ciudadana <- large_table(con,raw,cngmd_participacion_ciudadana) %>% retrieve_result()
#cngmd_participacion_ciudadana <-cngmd_participacion_ciudadana[,-c()]

```

```{r}
# Densidad de Medicos, Densidad de camas, Densidad de Hospitales
hospitales <- large_table(con,raw,recursos_hospitales) %>% retrieve_result() 
hospitales$clavemunicipio <- str_pad(hospitales$clavemunicipio,3,"left",'0')
hosp <- hospitales %>% mutate(cve_muni= as.integer(paste0(claveentidad,clavemunicipio)))
rm(hospitales)
```   

```{r}
defunciones_grales <- large_table(con,raw,defunciones_generales) %>% retrieve_result()
defunciones_grales$mun_regis <- str_pad(defunciones_grales$mun_regis,3,"left",'0')
def_g <- defunciones_grales %>% mutate(cve_muni= as.integer(paste0(ent_regis,mun_regis)))
rm(defunciones_grales)
```

```{r}
c_uno <- left_join(cngmd_proteccion_civil,cngmd_predial)
c_dos <-left_join(cngmd_agua_potable,cngmd_drenaje)
c_tres <- left_join(c_uno,c_dos)
c_cuatro <- left_join(indice,c_tres)
c_cinco <- left_join(ind_fin,c_cuatro)
c_seis <- left_join(complejidad,c_cinco)
c_siete <- left_join(internet_h,c_seis)
c_ocho <- left_join(c_siete, cngmd_recoleccion_basura)
c_nueve <-left_join(c_ocho, hosp)
c_matriz <-left_join(c_nueve, def_g)


rm(c_uno,c_dos,c_tres,c_cuatro,c_cinco,c_seis,c_siete,c_ocho,c_ocho,complejidad,cngmd_proteccion_civil,cngmd_predial,cngmd_agua_potable,cngmd_drenaje,indice,ind_fin, internet_h,cngmd_recoleccion_basura,u_cfe,hosp,c_nueve,def_g)
```

###########################################################################
VULNERABILIDADES
###########################################################################

```{r}
#dbrsocial::clear_results(connection = con)
coneval <- large_table(con,clean,coneval_municipios) %>% retrieve_result() %>%
  filter(data_date == "2015-a")
coneval$cve_muni <- as.integer(coneval$cve_muni)
```

```{r}
intercensal <- large_table(con,public,intercensal_mun_2015) %>% mutate(cve_muni= as.integer(paste0(ent,mun))) %>% retrieve_result()
```

```{r}
#Tiempo destinado a trabajo no remunerado, Brecha promedio de horas de trabajo de cuidados
cuidados <-large_table(con, raw,enut_cuidados) %>% retrieve_result()
```
* Volver a hacer la ingesta con la cve_muni

```{r}
concentrados <-large_table(con, clean, enigh_concentrados) %>% retrieve_result()
hogares <-large_table(con,clean, enigh_hogares) %>% retrieve_result()
ingresos <-large_table(con, clean, enigh_ingresos) %>% retrieve_result()
ingreso <-large_table(con, features, enigh_ingreso) %>% retrieve_result()
poblacion <-large_table(con, clean, enigh_poblacion) %>% retrieve_result()
trabajos <-large_table(con, clean, enigh_trabajos) %>% retrieve_result()
viviendas <-large_table(con, clean, enigh_viviendas) %>% retrieve_result()
carencias <-large_table(con, features, enigh_carencias) %>% retrieve_result()
gasto_hogar <-large_table(con, raw, enigh_gastohogar) %>% retrieve_result()
gasto_personas <-large_table(con, raw, enigh_gastopersonas) %>% retrieve_result()

concentrados$factor_hog <- as.integer(concentrados$factor_hog)
gasto_hogar$costo <- as.numeric(gasto_hogar$costo)
gasto_hogar$gasto_nm <- as.numeric(gasto_hogar$gasto_nm)
gasto_personas$gasto <- as.integer(gasto_personas$gasto)
gasto_personas$gasto_tri <- as.numeric(gasto_personas$gasto_tri)

enigh1 <- left_join(concentrados,hogares) 
enigh2 <- left_join(ingreso,ingresos) 
enigh3 <- left_join(poblacion,trabajos) 
enigh4 <- left_join(carencias,viviendas) 
enigh5 <- left_join(gasto_personas,gasto_hogar) 

enigh6 <- left_join(enigh1,enigh2)
enigh7 <- left_join(enigh3,enigh4)

enigh5$material <- as.numeric(enigh5$material)
enigh8 <- left_join(enigh5,enigh6)

enigh7$ubica_geo <- as.integer(enigh7$ubica_geo)
enigh <- left_join(enigh7,enigh8)

rm(concentrados,hogares,ingreso,ingresos,gasto_hogar,gasto_personas,carencias,viviendas,trabajos,poblacion,enigh1,enigh2,enigh3,enigh4,enigh5,enigh6,enigh7,enigh8)
```
* a nivel hogares

```{r}
v_uno <- left_join(intercensal,coneval)
```