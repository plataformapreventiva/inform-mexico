---
title: "estados_matrix_creation"
output: html_document
---

```{r setup, include=FALSE}
options(scipen=10000)
source("../utils.R")
```
## TODO 
* La ingesta de inpc está mal, sólo toma 32 de las 46 ciudades. 
* Moni iba a agregar la enigh

###########################################################################
AMENAZAS
###########################################################################

```{r, results = "hide"}
# INPC
inpc <- large_table(con,raw,inpc_estados) %>% 
  filter(fecha == "2016-9") %>% 
  select(-fecha)

# Sistema de alertas: liquidez y endeudamiento
s_alertas <- large_table(con,raw,sistemas_alertas) %>% 
  mutate(endeudamiento = (indicador1+indicador2+indicador3)/3,liquidez = 
           ingresosdelibredisposicion/(pi+pi_2+obligacionesacortoplazoyproveedoresycontratistas),
         nom_ent=entidadfederativa) %>% select(-entidadfederativa)
s_alertas$nom_ent <- str_replace_all(s_alertas$nom_ent, c("Ciudad de México" = "Distrito Federal","Coahuila" = "Coahuila de Zaragoza","Veracruz" = "Veracruz de Ignacio de la Llave","Michoacán" = "Michoacán de Ocampo"))
cves <- large_table(con, raw,geom_estados) %>% 
  select(cve_ent,nom_ent)
sistema_alertas <- left_join(cves, s_alertas, by = "nom_ent") %>% 
  select(cve_ent,endeudamiento,liquidez)

# Join
amenazas_edo <- left_join(inpc, sistema_alertas, by = "cve_ent") %>% retrieve_result()
  
# Generación de Reporte
amenazas_numericas_edo <- na.omit(scale(select_if(amenazas_edo, is.numeric)))

# Generación de Reporte
create_reports(amenazas_numericas_edo %>% data.table(), 
               task_name = "amenazas_edo", 
               output_dir = "../eda/reportes/amenazas") 
```

###########################################################################
CAPACIDADES
###########################################################################

```{r, results = "hide"}
# Selección y Construcción de Variables

cves <- large_table(con, raw,geom_estados) %>% 
  select(cve_ent,nom_ent)
# Jueces y agentes fiscales por cada cien mil habitantes
jueces <- large_table(con, raw, inegi_jueces) %>%
  mutate(nom_ent=entidadfederativa) %>%
  select(nom_ent,num_jueces) 
jueces$nom_ent <- str_replace_all(jueces$nom_ent, c("Ciudad de México" = "Distrito Federal","Ciudad de México" = "Distrito Federal"))
inegi_jueces <- left_join(cves, jueces, by = "nom_ent") %>% select(-nom_ent) %>%
  retrieve_result()

agentes_fiscales <- large_table(con, raw, inegi_agentes_fiscales) %>%
  rename(nom_ent=entidad_federativa) %>%
  select(nom_ent,num_agentes_fiscales) 
agentes_fiscales$nom_ent <- str_replace_all(agentes_fiscales$nom_ent, c("Ciudad de México" = "Distrito Federal","Ciudad de México" = "Distrito Federal"))
inegi_agentes_fiscales <- left_join(cves, agentes_fiscales, by = "nom_ent") %>% select(-nom_ent) %>%
  retrieve_result()

# Índice de sistema político estable y funcional
periodistas <- large_table(con,raw,imco_periodistas) %>% 
  rename(nom_ent=entidad_federativa) %>%
  select(-c(data_date,actualizacion_sedesol)) 
equidad_congreso <- large_table(con,raw,imco_equidad_congreso) %>% 
  rename(nom_ent=entidad_federativa) %>%
  select(-c(data_date,actualizacion_sedesol)) 
corrupcion_estatal <- large_table(con,raw,imco_corrupcion_estatal) %>% 
  rename(nom_ent=entidad_federativa) %>%
  select(-c(data_date,actualizacion_sedesol))
partidos <- large_table(con,raw,imco_corrupcion_partidos) %>% 
  select(-c(entidadfederativa,data_date,actualizacion_sedesol)) %>% retrieve_result()
corrupcion_partidos <- data.frame(nom_ent=c("Aguascalientes","Baja California","Baja California Sur","Campeche","Coahuila de Zaragoza","Colima","Chiapas","Chihuahua","Distrito Federal","Durango","Guanajuato","Guerrero","Hidalgo","Jalisco","México","Michoacán de Ocampo","Morelos","Nayarit","Nuevo León","Oaxaca","Puebla","Querétaro de Arteaga","Quintana Roo","San Luis Potosí","Sinaloa","Sonora","Tabasco","Tamaulipas","Tlaxcala","Veracruz de Ignacio de la Llave","Yucatán","Zacatecas"),partidos)
matrimonio_igualitario <- large_table(con,raw,imco_matrimonio_igualitario) %>% 
  rename(nom_ent=estado) %>% 
  select(-c(data_date,actualizacion_sedesol))
info <- large_table(con,raw,imco_info_publica) %>%
  mutate(cve_ent=as.character(entidad)) %>%
  select(-c(data_date,actualizacion_sedesol,entidad)) %>% distinct()
info_publica <- left_join(cves,info,by='cve_ent')
participacion_ciudadana <- large_table(con,raw,imco_participacion_ciudadana) %>%
  rename(nom_ent=entidad) %>% 
  select(-c(data_date,actualizacion_sedesol)) 
corrupcion_sector <- large_table(con,raw,imco_corrupcion_sector)

indice_sist_politico <- left_join(corrupcion_estatal,equidad_congreso, by='nom_ent') %>% 
  left_join(periodistas,by='nom_ent') %>%
  left_join(matrimonio_igualitario,by='nom_ent') %>%
  left_join(info_publica,by='nom_ent') %>%
  left_join(corrupcion_sector,by='nom_ent') %>%
  left_join(participacion_ciudadana,by='nom_ent') %>% retrieve_result() %>%
  left_join(corrupcion_partidos,by='nom_ent')

# Join
capacidades_edo <- left_join(inegi_jueces, inegi_agentes_fiscales, by="cve_ent") %>% 
  left_join(indice_sist_politico, by="cve_ent")

# Generación de Reporte
create_reports(capacidades_edo, 
               task_name = "capacidades_edo", 
               output_dir = "../eda/reportes/capacidades")
```

###########################################################################
VULNERABILIDADES
###########################################################################
```{r, results = "hide"}
##Total de habitantes por estado
poblacion <-large_table(con, clean, enigh_poblacion) %>% filter(data_date=='2016-a')  %>% 
  select(folioviv, foliohog, numren, sexo, edad, disc1, disc2, disc3, disc4, disc5, disc6, disc7, hor_4, min_4, usotiempo4) %>% 
  retrieve_result() %>% 
  group_by(folioviv, foliohog) %>% 
  summarise(personas_hogar =n())

concentrados <-large_table(con, clean, enigh_concentrados) %>% filter(data_date=='2016-a') %>%
  select(folioviv, foliohog, ubica_geo, tot_integ, factor_hog, data_date) %>% retrieve_result() 

poblacion_estado <- full_join(concentrados, poblacion, by=c("folioviv", "foliohog")) %>% 
  select(folioviv, factor_hog, personas_hogar) %>% 
  mutate(folioviv = as.character(folioviv),
         ent = str_pad(string = folioviv, width = 10, side = 'left', pad = '0'),
         ent = str_sub(ent, 1, 2),
         personas = as.numeric(factor_hog)*personas_hogar) %>% 
  select(ent, personas) %>% 
  group_by(ent) %>% 
  summarise_all(sum)

###Población discapacitados

poblacion_temp_disc <-large_table(con, clean, enigh_poblacion) %>% filter(data_date=='2016-a')%>% 
  select(folioviv, foliohog, numren, disc1, disc2, disc3, disc4, disc5, disc6, disc7) %>%  retrieve_result()

poblacion_disc <- poblacion_temp_disc %>% 
  mutate(disc_int = ifelse(disc1 %in% c(6) | disc2 %in% c(6) | disc3 %in% c(6) | disc4 %in% c(6) | disc5 %in% c(6) | 
                             disc6 %in% c(6) | disc7 %in% c(6), 1, 0),
         disc_fis = ifelse(disc1 %in% c(1,5) | disc2 %in% c(1,5) | disc3 %in% c(1,5) | 
                                disc4 %in% c(1,5) | disc5 %in% c(1,5) | disc6 %in% c(1,5) | disc7 %in% c(1,5), 1, 0),
         disc_sens = ifelse(disc1 %in% c(2:4) | disc2 %in% c(2:4) | disc3 %in% c(2:4) | 
                                disc4 %in% c(2:4) | disc5 %in% c(2:4) | disc6 %in% c(2:4) | disc7 %in% c(2:4), 1, 0),
         disc_men = ifelse(disc1 %in% c(7) | disc2 %in% c(7) | disc3 %in% c(7) | disc4 %in% c(7) | disc5 %in% c(7) | 
                             disc6 %in% c(7) | disc7 %in% c(7), 1, 0)) %>% 
  select(folioviv, foliohog, disc_int, disc_fis, disc_sens, disc_men) %>% 
  group_by(folioviv, foliohog) %>% 
  summarise_all(sum) 

concentrados <-large_table(con, clean, enigh_concentrados) %>% filter(data_date=='2016-a') %>%
  select(folioviv, foliohog, ubica_geo, tot_integ, factor_hog, data_date) %>% retrieve_result() %>% 
  mutate(factor_hog = as.integer(factor_hog))

pob_disc <- full_join(concentrados, poblacion_disc, by=c("folioviv", "foliohog")) %>% 
  select(folioviv, foliohog, factor_hog, disc_int, disc_fis, disc_sens, disc_men) %>% 
  mutate(folioviv = as.character(folioviv),
         ent = str_pad(string = folioviv, width = 10, side = 'left', pad = '0'),
         ent = str_sub(ent, 1, 2),
         factor_hog = as.integer(factor_hog),
         disc_int = disc_int*factor_hog,
         disc_fis = disc_fis*factor_hog,
         disc_sens = disc_sens*factor_hog,
         disc_men = disc_men*factor_hog) %>% 
  select(ent, disc_int, disc_fis, disc_sens, disc_men) %>% 
  group_by(ent) %>% 
  summarise_all(sum)

poblacion_discapacitados <- full_join(poblacion_estado, pob_disc, by=c("ent")) %>% 
                            mutate(disc_int = disc_int/personas,
                                   disc_fis = disc_fis/personas,
                                   disc_sens = disc_sens/personas,
                                   disc_men = disc_men/personas) %>% 
  select(ent, disc_int, disc_fis, disc_sens, disc_men)
  
poblacion_disc_intelectual <- poblacion_discapacitados %>% 
    select(ent, disc_int)

poblacion_disc_fisica <- poblacion_discapacitados %>% 
    select(ent, disc_fis)

poblacion_disc_sensorial <- poblacion_discapacitados %>% 
    select(ent, disc_sens)
    
poblacion_disc_mental <- poblacion_discapacitados %>% 
    select(ent, disc_men)
  

##Acceso a guarderías. A nivel hogares donde al menos uno de los habitantes del hogar tiene la prestación de guarderias. No se puede dividir por sexo debido a que si se cuentan los hogares con la prestación hay casos en los que son más de un habitante y estos pueden ser hombres o mujeres.

poblacion_temp_trab <-large_table(con, clean, enigh_trabajos) %>% filter(data_date=='2016-a')%>% 
  select(folioviv, foliohog, numren, pres_6) %>%  retrieve_result()

concentrados <-large_table(con, clean, enigh_concentrados) %>% filter(data_date=='2016-a') %>%
  select(folioviv, foliohog, ubica_geo, tot_integ, factor_hog, data_date) %>% retrieve_result() %>% 
  mutate(folioviv = as.character(folioviv),
         factor_hog = as.integer(factor_hog)) 

concentrados_estado <- concentrados %>% 
  mutate(ent = str_pad(string = folioviv, width = 10, side = 'left', pad = '0'),
         ent = str_sub(ent, 1, 2))%>%
  select(ent, factor_hog) %>% 
  group_by(ent) %>% 
  summarise_all(sum)

guarderias <- poblacion_temp_trab %>% 
  mutate(ac_guar = ifelse(pres_6 %in% c(6), 1, 0),
         folioviv = as.character(folioviv),
         ent = str_pad(string = folioviv, width = 10, side = 'left', pad = '0'),
         ent = str_sub(ent, 1, 2)) %>%
  filter(ac_guar == 1) %>% 
  group_by(ent, folioviv, foliohog) %>% 
  summarise(personas_guar_hogar =n())  

hogares_guarderia <- inner_join(concentrados, guarderias, by=c("folioviv","foliohog")) %>% 
  select(ent, folioviv, foliohog, factor_hog, personas_guar_hogar)  %>% 
  mutate(factor_hog = as.integer(factor_hog),
         tot_hog_guar = factor_hog*foliohog) %>%  
  select(ent, tot_hog_guar) %>% 
  group_by(ent) %>% 
  summarise_all(sum)

hogares_guarderias <- full_join(hogares_guarderia, concentrados_estado, by = c("ent")) %>% 
  mutate(proporcion_hog_guar = tot_hog_guar/factor_hog) %>% 
  select(ent, proporcion_hog_guar)

##Brecha salarial

ingresos_temp <-large_table(con, clean, enigh_ingresos) %>% filter(data_date=='2016-a')%>%
  select(folioviv, foliohog, numren, clave, ing_1) %>%
    retrieve_result()

poblacion_temp <-large_table(con, clean, enigh_poblacion) %>% filter(data_date=='2016-a')%>% 
  select(folioviv, foliohog, numren, sexo) %>%  retrieve_result()

base_ingreso <- full_join(ingresos_temp, poblacion_temp, by = c("folioviv", "foliohog", "numren")) %>% 
  filter(clave == c("P001", "P011", "P018")) %>% 
  mutate(ent = str_pad(string = folioviv, width = 10, side = 'left', pad = '0'),
         ent = str_sub(ent, 1, 2)) 

base_ingreso <- base_ingreso %>% 
  group_by(sexo, ent) %>% 
  summarise(media_salario = mean(ing_1, na.rm = T))

base_ing_mujeres <- base_ingreso %>% 
  filter(sexo == 2) %>% 
  subset(select = c(ent, media_salario))

names(base_ing_mujeres)[names(base_ing_mujeres) == 'media_salario'] <- 'media_salario_mujeres'
  
base_ing_hombres <- base_ingreso %>% 
  filter(sexo == 1) %>% 
  subset(select = c(ent, media_salario))

names(base_ing_hombres)[names(base_ing_hombres) == 'media_salario'] <- 'media_salario_hombres'

brecha_salarial <- left_join(base_ing_hombres, base_ing_mujeres, by = c("ent")) %>% 
  mutate(brecha_salario_mensual = media_salario_hombres-media_salario_mujeres) %>% 
  subset(select = c(ent, brecha_salario_mensual)) 
  
## Join de vulnerabilidades de estado

vulnerabilidades1 <- left_join(poblacion_disc_intelectual, poblacion_disc_fisica, by = "ent")
vulnerabilidades2 <- left_join(vulnerabilidades1, poblacion_disc_sensorial, by = "ent")
vulnerabilidades3 <- left_join(vulnerabilidades2, poblacion_disc_mental, by = "ent")
vulnerabilidades4 <- left_join(vulnerabilidades3, hogares_guarderias, by = "ent")
vulnerabilidades5 <- left_join(vulnerabilidades4, brecha_salarial, by = "ent")

vulnerabilidades_numericas <- na.omit(scale(select_if(vulnerabilidades5, is.numeric)))

create_reports(vulnerabilidades_numericas,
               task_name = "vulnerabilidades_estado", 
               output_dir = "../eda/reportes/vulnerabilidades_estado")
